<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile - FIntrack Pro</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        .profile-header {
            background: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2.5rem;
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('page_home') }}">
                <i class="bi bi-egg-fried"></i>
                FIntrack Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('page_home') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{{ url_for('page_profile') }}">
                            <i class="bi bi-person-circle"></i> Profile & Favorites
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="profile-header">
        <div class="container">
            <h1 class="display-4"><i class="bi bi-person-circle"></i> Your Profile</h1>
            <p class="lead">Manage your saved recipes and shopping lists.</p>
        </div>
    </header>

    <main class="container my-4">
        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body p-0">
                
                <ul class="nav nav-tabs nav-pills nav-fill" id="profileTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="favorites-tab" data-bs-toggle="tab" data-bs-target="#favorites-content" type="button" role="tab" aria-controls="favorites-content" aria-selected="true">
                            <i class="bi bi-heart-fill"></i> My Favorite Recipes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shopping-list-tab" data-bs-toggle="tab" data-bs-target="#shopping-list-content" type="button" role="tab" aria-controls="shopping-list-content" aria-selected="false">
                            <i class="bi bi-cart-check-fill"></i> My Shopping List
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="profileTabContent">
                    
                    <div class="tab-pane fade show active" id="favorites-content" role="tabpanel" aria-labelledby="favorites-tab" tabindex="0">
                        
                        <div id="fav-loading-spinner" class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading your favorites...</p>
                        </div>

                        <div id="fav-no-results" class="alert alert-info" style="display: none;">
                            You haven't saved any favorite recipes yet.
                        </div>

                        <div id="favorites-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        </div>

                    </div>

                    <div class="tab-pane fade" id="shopping-list-content" role="tabpanel" aria-labelledby="shopping-list-tab" tabindex="0">
                        
                        <div id="shop-loading-spinner" class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading your shopping list...</p>
                        </div>

                        <div id="shop-no-results" class="alert alert-info" style="display: none;">
                            Your shopping list is empty. Add recipes from the recipe page to build your list.
                        </div>
                        
                        <div id="shopping-list-container" class="row g-4">
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 FIntrack Pro. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const favContainer = document.getElementById('favorites-container');
            const favSpinner = document.getElementById('fav-loading-spinner');
            const favNoResults = document.getElementById('fav-no-results');

            const shopContainer = document.getElementById('shopping-list-container');
            const shopSpinner = document.getElementById('shop-loading-spinner');
            const shopNoResults = document.getElementById('shop-no-results');

            const fetchFavorites = async () => {
                try {
                    const response = await fetch('/api/favorites');
                    if (!response.ok) throw new Error('Failed to fetch favorites');
                    
                    const favorites = await response.json();
                    
                    favSpinner.style.display = 'none';
                    favContainer.innerHTML = '';

                    if (favorites.length === 0) {
                        favNoResults.style.display = 'block';
                    } else {
                        favNoResults.style.display = 'none';
                        favorites.forEach(recipe => {
                            const cardHtml = createFavoriteCard(recipe);
                            favContainer.innerHTML += cardHtml;
                        });
                    }
                } catch (error) {
                    console.error('Error fetching favorites:', error);
                    favSpinner.style.display = 'none';
                    favContainer.innerHTML = '<div class="alert alert-danger">Could not load favorites.</div>';
                }
            };

            const fetchShoppingList = async () => {
                try {
                    const response = await fetch('/api/shopping-list');
                    if (!response.ok) throw new Error('Failed to fetch shopping list');
                    
                    const listData = await response.json();
                    
                    shopSpinner.style.display = 'none';
                    shopContainer.innerHTML = '';

                    const categories = Object.keys(listData);
                    if (categories.length === 0 || categories.every(key => listData[key].length === 0)) {
                        shopNoResults.style.display = 'block';
                    } else {
                        shopNoResults.style.display = 'none';
                        categories.forEach(category => {
                            const items = listData[category];
                            if (items.length > 0) {
                                const listHtml = createShoppingListCategory(category, items);
                                shopContainer.innerHTML += listHtml;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error fetching shopping list:', error);
                    shopSpinner.style.display = 'none';
                    shopContainer.innerHTML = '<div class="alert alert-danger">Could not load shopping list.</div>';
                }
            };

            function createFavoriteCard(recipe) {
                const imageUrl = recipe.image_url || `https://placehold.co/600x400/555/FFF?text=${encodeURIComponent(recipe.title)}`;
                const note = recipe.note ? `<p class="card-text small text-muted fst-italic">"${recipe.note}"</p>` : '';

                return `
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 rounded-3">
                            <img src="${imageUrl}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${recipe.title}">
                            <div class="card-body">
                                <h5 class="card-title">${recipe.title}</h5>
                                ${note}
                                <a href="/recipe/${encodeURIComponent(recipe.title)}" class="btn btn-primary btn-sm stretched-link mt-2">
                                    View Recipe
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createShoppingListCategory(category, items) {
                const itemHtml = items.map(item => `
                    <li class="list-group-item">
                        <input class="form-check-input me-2" type="checkbox" value="" id="item-${item}">
                        <label class="form-check-label" for="item-${item}">
                            ${item}
                        </label>
                    </li>
                `).join('');

                return `
                    <div class="col-md-6 col-lg-4">
                        <h4 class="h5 text-primary-emphasis">${category}</h4>
                        <ul class="list-group">
                            ${itemHtml}
                        </ul>
                    </div>
                `;
            }

            fetchFavorites();
            fetchShoppingList();
            
        });
    </script>
</body>
</html>